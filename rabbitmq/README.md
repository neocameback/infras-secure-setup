# A secured RabbitMQ running on Docker container

This repository contains a complete setup for running RabbitMQ in a Docker container with enhanced security features, monitoring, and best practices.

## 🚀 Quick Start

1. **Clone and navigate to the directory:**
   ```bash
   cd rabbitmq
   ```

2. **Set up secure environment variables:**
   ```bash
   # Copy the example environment file
   cp rabbitmq.env.example rabbitmq.env
   
   # Edit rabbitmq.env with your secure credentials
   nano rabbitmq.env
   ```

3. **Make scripts executable:**
   ```bash
   chmod +x ssl-setup.sh generate-definitions.sh
   ```

4. **Start RabbitMQ:**
   ```bash
   ./start.sh
   ```

5. **Access the Management UI:**
   - URL: http://localhost:15672
   - Username: `admin`
   - Password: `<RABBITMQ_PASSWORD>` (from your rabbitmq.env file)

## 📁 Project Structure

```
rabbitmq/
├── docker-compose.yml          # Docker Compose configuration
├── rabbitmq.env               # Environment variables (create from rabbitmq.env.example)
├── rabbitmq.env.example       # Example environment file
├── config/
│   ├── rabbitmq.conf           # RabbitMQ main configuration
│   ├── definitions.json        # Initial users, vhosts, exchanges, queues (auto-generated)
│   ├── enabled_plugins         # Enabled RabbitMQ plugins
│   └── ssl/                    # SSL certificates (generated by ssl-setup.sh)
├── start.sh                    # Secure startup script
├── stop.sh                     # Stop script
├── generate-definitions.sh     # Generate secure definitions.json
├── ssl-setup.sh               # SSL certificate generation script
└── README.md                  # This file
```

## 🔐 Security Features

### Environment-Based Security
- **Secure Credentials**: Passwords and cookies stored in `rabbitmq.env` (not in config files)
- **Auto-Generated Definitions**: `definitions.json` generated with proper password hashes
- **No Hardcoded Secrets**: All sensitive data externalized to environment variables

### Authentication & Authorization
- **Default Admin User**: `admin` with secure password from environment
- **VHost Isolation**: Separate vhosts for different applications
- **Permission Management**: Granular permissions per user/vhost

### Network Security
- **Port Configuration**: 
  - AMQP: 5672 (for applications)
  - Management: 15672 (for web UI)
- **Network Isolation**: Custom Docker network with specific subnet
- **SSL/TLS Support**: Ready for SSL certificate integration

### Data Security
- **Persistent Storage**: Data and logs stored in Docker volumes
- **File Permissions**: Proper file permissions for configuration files
- **Erlang Cookie**: Secure cluster communication

## 🛠️ Configuration

### Environment Variables
The setup uses the following environment variables from `rabbitmq.env`:
- `RABBITMQ_DEFAULT_USER`: admin (default)
- `RABBITMQ_DEFAULT_PASS`: **Required** - Set your secure password
- `RABBITMQ_DEFAULT_VHOST`: / (default)
- `RABBITMQ_ERLANG_COOKIE`: **Required** - Set your secure Erlang cookie

**Security Note**: Never commit `rabbitmq.env` to version control. It contains sensitive credentials.

### Performance Settings
- **Memory Limit**: 60% of available memory
- **Disk Free Limit**: 2GB minimum
- **Message Size Limit**: 128MB
- **Connection Limits**: 1000 connections, 2000 channels

## 🔐 Secure Credential Setup

### Generate Secure Credentials
```bash
# Generate a secure password
openssl rand -base64 32

# Generate a secure Erlang cookie
openssl rand -base64 32
```

### Update Environment File
1. Copy the example file:
   ```bash
   cp rabbitmq.env.example rabbitmq.env
   ```

2. Edit `rabbitmq.env` with your secure values:
   ```bash
   nano rabbitmq.env
   ```

3. Replace the placeholder values:
   ```bash
   RABBITMQ_DEFAULT_PASS=your_generated_secure_password
   RABBITMQ_ERLANG_COOKIE=your_generated_secure_cookie
   ```

## 🔒 SSL/TLS Setup

To enable SSL/TLS encryption:

1. **Generate SSL certificates:**
   ```bash
   ./ssl-setup.sh
   ```

2. **Update configuration:**
   Uncomment SSL lines in `config/rabbitmq.conf`:
   ```conf
   listeners.ssl.default = 5671
   ssl_options.certfile = /etc/rabbitmq/ssl/cert.pem
   ssl_options.keyfile = /etc/rabbitmq/ssl/key.pem
   ssl_options.cacertfile = /etc/rabbitmq/ssl/ca.pem
   ```

3. **Restart RabbitMQ:**
   ```bash
   ./stop.sh
   ./start.sh
   ```

## 📊 Monitoring & Management

### Management UI
- **URL**: http://localhost:15672
- **Features**: Queue monitoring, connection management, user administration

### Enabled Plugins
- `rabbitmq_management`: Web-based management UI
- `rabbitmq_management_agent`: Management API
- `rabbitmq_prometheus`: Prometheus metrics
- `rabbitmq_tracing`: Message tracing
- `rabbitmq_auth_backend_http`: HTTP authentication backend
- `rabbitmq_auth_backend_oauth2`: OAuth2 authentication

### Health Checks
- **Docker Health Check**: Automatic container health monitoring
- **RabbitMQ Diagnostics**: Built-in diagnostic commands

## 🚀 Usage Examples

### Start Services
```bash
# Start RabbitMQ
./start.sh

# Or use docker-compose directly
docker-compose up -d
```

### Stop Services
```bash
# Stop RabbitMQ
./stop.sh

# Or use docker-compose directly
docker-compose down
```

### View Logs
```bash
# View real-time logs
docker-compose logs -f

# View specific service logs
docker-compose logs rabbitmq
```

### Access Container
```bash
# Access RabbitMQ container shell
docker-compose exec rabbitmq bash

# Run RabbitMQ commands
docker-compose exec rabbitmq rabbitmqctl list_users
docker-compose exec rabbitmq rabbitmqctl list_queues
```

## 🔧 Troubleshooting

### Common Issues

1. **Port Already in Use**
   ```bash
   # Check what's using the ports
   sudo netstat -tulpn | grep :5672
   sudo netstat -tulpn | grep :15672
   ```

2. **Permission Denied**
   ```bash
   # Fix file permissions
   chmod 644 config/rabbitmq.conf
   chmod 644 config/definitions.json
   chmod 644 config/enabled_plugins
   ```

3. **Container Won't Start**
   ```bash
   # Check logs
   docker-compose logs rabbitmq
   
   # Check container status
   docker-compose ps
   ```

### Reset Everything
```bash
# Stop and remove everything
docker-compose down -v
docker system prune -f

# Start fresh
./start.sh
```

## 📈 Production Considerations

### Security
- Change default passwords
- Use SSL/TLS in production
- Implement proper firewall rules
- Regular security updates

### Performance
- Monitor memory and disk usage
- Adjust limits based on workload
- Consider clustering for high availability

### Backup
- Regular backup of data volumes
- Export configuration and definitions
- Test restore procedures

## 🤝 Contributing

1. Fork the repository
2. Create a feature branch
3. Make your changes
4. Test thoroughly
5. Submit a pull request

## 📄 License

This project is licensed under the MIT License - see the LICENSE file for details.

## 🆘 Support

For issues and questions:
1. Check the troubleshooting section
2. Review RabbitMQ documentation
3. Open an issue in the repository